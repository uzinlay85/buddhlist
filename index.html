<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ဘုရားဝတ်တက် စစ်ဆေးရန်</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pyidaungsu', sans-serif; }
        .grid-container { display: grid; gap: 0.5rem; }
        #seat-tooltip { pointer-events: none; white-space: pre-wrap; transition: opacity 0.2s; }
        .seat.absent { border: 3px solid #ef4444 !important; transform: scale(1.05 ); box-shadow: 0 0 8px rgba(239, 68, 68, 0.5); }
        .seat.on-leave { border: 3px solid #eab308 !important; transform: scale(1.05); box-shadow: 0 0 8px rgba(234, 179, 8, 0.5); }
        .seat.empty { background-color: #f3f4f6; border: 1px dashed #d1d5db; }
        .seat.left { background-color: #e5e7eb !important; color: #6b7280 !important; border-color: #d1d5db !important; cursor: not-allowed !important; }
        .list-container { min-height: 100px; transition: height 0.3s ease; }
        #admin-modal { display: none; }
        #admin-modal.show { display: flex; }
        .modal-content { max-height: 80vh; }
        .table-input { border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; width: 100%; }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <!-- Admin Panel Button -->
    <div class="fixed top-4 right-4 z-50">
        <button id="admin-panel-button" class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-gray-700 transition">
            Admin Panel
        </button>
    </div>

    <div class="max-w-screen-2xl mx-auto bg-white rounded-2xl shadow-lg p-6">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">ဘုရားဝတ်တက် စစ်ဆေးရေးဇယား</h1>
            <p class="text-gray-600 mt-1">ခုံများကို နှိပ်၍ တက်ရောက်မှု အခြေအနေ ပြောင်းလဲနိုင်ပါသည်။</p>
            <!-- Updated Click Order Text -->
            <p class="text-xs text-gray-500 mt-2">( ပထမကလစ် = ခွင့်ရှိသူ | ဒုတိယကလစ် = ပျက်ကွက် | တတိယကလစ် = တက်ရောက် )</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-grow">
                <div class="bg-blue-600 text-white text-center py-2 rounded-t-lg font-bold shadow-md">စာချဆရာတော်များနှင့် ကျမ်းပြီးသံဃာတော်များ</div>
                <div id="seating-chart-container" class="p-4 bg-gray-50 border rounded-b-lg overflow-x-auto"></div>
                <div class="mt-4 flex justify-center">
                    <button id="reset-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        အားလုံးကိုပြန်လည်သတ်မှတ်ရန်
                    </button>
                </div>
            </div>

            <div class="lg:w-1/3 xl:w-1/4 flex-shrink-0 space-y-6">
                <div class="bg-white p-4 rounded-lg shadow-md border list-container">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div><h2 class="text-xl font-bold text-red-700">ပျက်ကွက်စာရင်း</h2><p id="current-date-absent" class="text-sm text-gray-500"></p></div>
                        <button id="copy-absent-button" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md">ကူးယူရန်</button>
                    </div>
                    <ul id="absent-list" class="space-y-2 text-gray-700"></ul>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md border list-container">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div><h2 class="text-xl font-bold text-yellow-700">ခွင့်ရှိသူစာရင်း</h2><p id="current-date-leave" class="text-sm text-gray-500"></p></div>
                        <button id="copy-leave-button" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-md">ကူးယူရန်</button>
                    </div>
                    <ul id="on-leave-list" class="space-y-2 text-gray-700"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="seat-tooltip" class="hidden absolute p-2 bg-gray-900 text-white text-sm rounded-md shadow-lg z-50"></div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-4xl modal-content">
            <h2 class="text-2xl font-bold mb-4">ကျောင်းသားစာရင်း ပြင်ဆင်ရန်</h2>
            <div class="overflow-auto border rounded-lg" style="max-height: 60vh;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">အတန်း</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ခုံ</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">အမည်</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">အဆောင်</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ကျောင်းထွက်</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ဖျက်ရန်</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Admin table rows will be generated here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-6 flex justify-between items-center">
                <button id="add-row-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">အတန်းသစ်ထည့်ရန်</button>
                <div>
                    <button id="download-csv-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">CSV ဒေါင်းလုဒ်လုပ်ရန်</button>
                    <button id="close-admin-modal" class="ml-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">ပိတ်ရန်</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const seatingChartContainer = document.getElementById('seating-chart-container');
        const absentList = document.getElementById('absent-list');
        const onLeaveList = document.getElementById('on-leave-list');
        const resetButton = document.getElementById('reset-button');
        const copyAbsentButton = document.getElementById('copy-absent-button');
        const copyLeaveButton = document.getElementById('copy-leave-button');
        const tooltip = document.getElementById('seat-tooltip');
        const currentDateAbsentEl = document.getElementById('current-date-absent');
        const currentDateLeaveEl = document.getElementById('current-date-leave');
        const adminPanelButton = document.getElementById('admin-panel-button');
        const adminModal = document.getElementById('admin-modal');
        const closeAdminModalButton = document.getElementById('close-admin-modal');
        const adminTableBody = document.getElementById('admin-table-body');
        const addRowButton = document.getElementById('add-row-button');
        const downloadCsvButton = document.getElementById('download-csv-button');

        // --- Constants & State ---
        const dormColors = { 'လှ': 'bg-sky-100 text-sky-800 border-sky-200', 'သိမ်': 'bg-teal-100 text-teal-800 border-teal-200', 'ပညာ': 'bg-indigo-100 text-indigo-800 border-indigo-200', 'အဘိ': 'bg-purple-100 text-purple-800 border-purple-200', 'ရ': 'bg-rose-100 text-rose-800 border-rose-200', 'ဋ': 'bg-fuchsia-100 text-fuchsia-800 border-fuchsia-200', 'ပ': 'bg-pink-100 text-pink-800 border-pink-200', 'ဓံ': 'bg-lime-100 text-lime-800 border-lime-200', 'သာ': 'bg-emerald-100 text-emerald-800 border-emerald-200', 'ဓရ': 'bg-cyan-100 text-cyan-800 border-cyan-200', 'ဝိ': 'bg-orange-100 text-orange-800 border-orange-200', 'ရွှေ': 'bg-amber-100 text-amber-800 border-amber-200', 'မံ': 'bg-slate-200 text-slate-800 border-slate-300', 'လှိုင်': 'bg-green-100 text-green-800 border-green-200', 'ကြည်': 'bg-violet-100 text-violet-800 border-violet-200', 'default': 'bg-gray-200 text-gray-800 border-gray-300' };
        let studentDataByClass = {};
        let allStudents = [];

        // --- Data Loading ---
        async function loadStudentData() {
            try {
                const response = await fetch('students.csv?t=' + new Date().getTime()); // Cache busting
                if (!response.ok) throw new Error('Network response was not ok');
                const csvText = await response.text();
                
                studentDataByClass = {};
                allStudents = [];
                const lines = csvText.trim().split('\n');
                const headers = lines[0].trim().split(',');
                const dataLines = lines.slice(1);

                dataLines.forEach(line => {
                    const values = line.split(',');
                    const student = {};
                    headers.forEach((header, i) => {
                        student[header.trim()] = values[i] ? values[i].trim() : '';
                    });
                    
                    allStudents.push(student);

                    const { Class: classNum, Seat: seatNum, Name: name, Left: isLeft } = student;
                    if (classNum && seatNum && name) {
                        if (!studentDataByClass[classNum]) studentDataByClass[classNum] = {};
                        studentDataByClass[classNum][seatNum] = { ...student, isLeft: isLeft === 'true' };
                    }
                });
                createSeatingChart();
                updateAllLists();
            } catch (error) {
                console.error('Error loading CSV:', error);
                seatingChartContainer.innerHTML = '<p class="text-red-500 text-center">ကျောင်းသားစာရင်းဖိုင် (CSV) ကို ဖတ်ရာတွင် အမှားအယွင်းဖြစ်ပွားပါသည်။</p>';
            }
        }

        // --- UI Generation ---
        function createSeatingChart() {
            seatingChartContainer.innerHTML = '';
            seatingChartContainer.classList.add('space-y-4');
            const sortedClasses = Object.keys(studentDataByClass).sort((a, b) => parseInt(a) - parseInt(b));

            for (const classNum of sortedClasses) {
                const classData = studentDataByClass[classNum];
                const seatNumbersInClass = Object.keys(classData).map(Number);
                const maxSeatsInThisRow = seatNumbersInClass.length > 0 ? Math.max(...seatNumbersInClass) : 0;

                const rowContainer = document.createElement('div');
                rowContainer.innerHTML = `<div class="font-bold text-gray-700 mb-2 text-lg">အတန်း - ${classNum}</div>`;
                const rowGrid = document.createElement('div');
                rowGrid.className = 'grid-container';
                rowGrid.style.gridTemplateColumns = `repeat(${maxSeatsInThisRow > 0 ? maxSeatsInThisRow : 16}, minmax(0, 1fr))`;

                for (let seatNum = 1; seatNum <= maxSeatsInThisRow; seatNum++) {
                    const student = classData[seatNum];
                    const seatElement = document.createElement('div');
                    seatElement.className = 'seat h-24 flex flex-col items-center justify-center rounded-md p-1 transition-all duration-200 ease-in-out text-center border';
                    seatElement.dataset.classNum = classNum;
                    seatElement.dataset.seatNum = seatNum;

                    if (student && student.Name) {
                        const colorClasses = (dormColors[student.School] || dormColors.default).split(' ');
                        const studentInfo = student.School ? `${student.Name} (${student.School})` : student.Name;
                        seatElement.innerHTML = `<span class="font-bold text-sm">${seatNum}</span><span class="text-[10px] leading-tight mt-1">${studentInfo}</span>`;
                        seatElement.classList.add(...colorClasses);
                        seatElement.dataset.name = studentInfo;

                        if (student.isLeft) {
                            seatElement.classList.add('left');
                            seatElement.innerHTML += `<span class="text-[9px] font-bold text-red-600 mt-1">ကျောင်းထွက်</span>`;
                        } else {
                            seatElement.classList.add('cursor-pointer', 'transform', 'hover:scale-110');
                            seatElement.addEventListener('click', cycleAttendanceState);
                            seatElement.addEventListener('mouseover', showTooltip);
                            seatElement.addEventListener('mouseout', hideTooltip);
                            seatElement.addEventListener('mousemove', moveTooltip);
                        }
                    } else {
                        seatElement.classList.add('empty');
                        seatElement.innerHTML = `<span class="font-bold text-sm text-gray-400">${seatNum}</span>`;
                    }
                    rowGrid.appendChild(seatElement);
                }
                rowContainer.appendChild(rowGrid);
                seatingChartContainer.appendChild(rowContainer);
            }
        }

        // --- Attendance & List Management ---
        
        /**
         * MODIFIED: Swapped the click order.
         * 1st Click -> On Leave (ခွင့်)
         * 2nd Click -> Absent (ပျက်ကွက်)
         * 3rd Click -> Present (ပြန်ရောက်)
         */
        function cycleAttendanceState(event) {
            const seat = event.currentTarget;
            if (seat.classList.contains('on-leave')) {
                // Currently on-leave, switch to absent
                seat.classList.remove('on-leave');
                seat.classList.add('absent');
            } else if (seat.classList.contains('absent')) {
                // Currently absent, switch to present (remove all)
                seat.classList.remove('absent');
            } else {
                // Currently present, switch to on-leave
                seat.classList.add('on-leave');
            }
            updateAllLists();
        }

        function updateAllLists() { updateList('absent', absentList, copyAbsentButton); updateList('on-leave', onLeaveList, copyLeaveButton); }
        function updateList(state, listElement, buttonElement) { listElement.innerHTML = ''; const seats = document.querySelectorAll(`.seat.${state}`); const stateMessages = { 'absent': 'ပျက်ကွက်သူ မရှိပါ။', 'on-leave': 'ခွင့်ရှိသူ မရှိပါ။' }; const itemColors = { 'absent': 'bg-red-50 text-red-800', 'on-leave': 'bg-yellow-50 text-yellow-800' }; if (seats.length === 0) { listElement.innerHTML = `<li class="text-gray-500">${stateMessages[state]}</li>`; buttonElement.disabled = true; buttonElement.classList.add('opacity-50', 'cursor-not-allowed'); } else { buttonElement.disabled = false; buttonElement.classList.remove('opacity-50', 'cursor-not-allowed'); const sortedSeats = Array.from(seats).sort((a, b) => { const classA = parseInt(a.dataset.classNum, 10); const seatA = parseInt(a.dataset.seatNum, 10); const classB = parseInt(b.dataset.classNum, 10); const seatB = parseInt(b.dataset.seatNum, 10); if (classA !== classB) return classA - classB; return seatA - seatB; }); sortedSeats.forEach(seat => { const listItem = document.createElement('li'); listItem.className = `p-2 rounded-md text-sm ${itemColors[state]}`; listItem.textContent = `အတန်း ${seat.dataset.classNum}၊ ခုံ ${seat.dataset.seatNum}: ${seat.dataset.name || ''}`; listElement.appendChild(listItem); }); } }
        function resetAllSeats() { document.querySelectorAll('.seat:not(.left)').forEach(seat => seat.classList.remove('absent', 'on-leave')); updateAllLists(); }
        function copyList(state, buttonElement) { const listItems = state === 'absent' ? absentList.querySelectorAll('li') : onLeaveList.querySelectorAll('li'); if (listItems.length === 0 || (listItems.length === 1 && listItems[0].classList.contains('text-gray-500'))) return; const dateString = getBurmeseDate(); const title = state === 'absent' ? 'ဘုရားဝတ်တက် ပျက်ကွက်စာရင်း' : 'ဘုရားဝတ်တက် ခွင့်ရှိသူစာရင်း'; let listText = `${title}\n(${dateString})\n\n`; listItems.forEach(item => { listText += `${item.textContent}\n`; }); navigator.clipboard.writeText(listText.trim()).catch(err => console.error('Failed to copy: ', err)); }
        function showTooltip(event) { const seat = event.currentTarget; if (seat.dataset.name) { tooltip.textContent = seat.dataset.name; tooltip.classList.remove('hidden'); } }
        function hideTooltip() { tooltip.classList.add('hidden'); }
        function moveTooltip(event) { tooltip.style.left = `${event.pageX + 15}px`; tooltip.style.top = `${event.pageY + 15}px`; }
        function getBurmeseDate() { const today = new Date(); const year = today.getFullYear(); const month = today.getMonth(); const day = today.getDate(); const burmeseMonths = ["ဇန်နဝါရီ", "ဖေဖော်ဝါရီ", "မတ်", "ဧပြီ", "မေ", "ဇွန်", "ဇူလိုင်", "ဩဂုတ်", "စက်တင်ဘာ", "အောက်တိုဘာ", "နိုဝင်ဘာ", "ဒီဇင်ဘာ"]; const burmeseNumerals = ["၀", "၁", "၂", "၃", "၄", "၅", "၆", "၇", "၈", "၉"]; const toBurmeseNumeral = (num) => String(num).split('').map(digit => burmeseNumerals[parseInt(digit)]).join(''); return `${burmeseMonths[month]}လ ${toBurmeseNumeral(day)} ရက်၊ ${toBurmeseNumeral(year)}`; }

        // --- Admin Panel Logic ---
        function openAdminPanel() { populateAdminTable(); adminModal.classList.add('show'); }
        function closeAdminPanel() { adminModal.classList.remove('show'); }
        function populateAdminTable() { adminTableBody.innerHTML = ''; allStudents.sort((a, b) => { const classA = parseInt(a.Class, 10); const seatA = parseInt(a.Seat, 10); const classB = parseInt(b.Class, 10); const seatB = parseInt(b.Seat, 10); if (classA !== classB) return classA - classB; return seatA - seatB; }).forEach((student, index) => { const row = createAdminTableRow(student, index); adminTableBody.appendChild(row); }); }
        function createAdminTableRow(student, index) { const row = document.createElement('tr'); row.dataset.index = index; row.innerHTML = ` <td class="px-4 py-2"><input type="text" value="${student.Class || ''}" class="table-input" data-field="Class"></td> <td class="px-4 py-2"><input type="text" value="${student.Seat || ''}" class="table-input" data-field="Seat"></td> <td class="px-4 py-2"><input type="text" value="${student.Name || ''}" class="table-input" data-field="Name"></td> <td class="px-4 py-2"><input type="text" value="${student.School || ''}" class="table-input" data-field="School"></td> <td class="px-4 py-2 text-center"><input type="checkbox" ${student.Left === 'true' ? 'checked' : ''} class="h-5 w-5" data-field="Left"></td> <td class="px-4 py-2 text-center"><button class="text-red-500 hover:text-red-700 delete-row-button">ဖျက်ရန်</button></td> `; row.querySelector('.delete-row-button').addEventListener('click', () => { row.remove(); }); return row; }
        addRowButton.addEventListener('click', () => { const newStudent = { Class: '', Seat: '', Name: '', School: '', Left: 'false' }; const newIndex = adminTableBody.rows.length; const row = createAdminTableRow(newStudent, newIndex); adminTableBody.appendChild(row); });
        downloadCsvButton.addEventListener('click', () => { const headers = ['Class', 'Seat', 'Name', 'School', 'Left']; let csvContent = headers.join(',') + '\n'; const rows = Array.from(adminTableBody.rows); rows.forEach(row => { const classVal = row.querySelector('[data-field="Class"]').value; const seatVal = row.querySelector('[data-field="Seat"]').value; const nameVal = row.querySelector('[data-field="Name"]').value; const schoolVal = row.querySelector('[data-field="School"]').value; const leftVal = row.querySelector('[data-field="Left"]').checked; if (nameVal) { csvContent += `"${classVal}","${seatVal}","${nameVal}","${schoolVal}","${leftVal}"\n`; } }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", "students_updated.csv"); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); setTimeout(() => { alert("CSV ဖိုင်ကို ဒေါင်းလုဒ်လုပ်ပြီးပါပြီ။ စာမျက်နှာကို အသစ်ပြန်လည်စတင်ပါမည်။"); closeAdminPanel(); loadStudentData(); }, 500); });

        // --- Event Listeners ---
        adminPanelButton.addEventListener('click', () => { const password = prompt("Admin Password ကိုထည့်ပါ:"); if (password === "Ashin@135") { openAdminPanel(); } else if (password !== null) { alert("Password မှားယွင်းနေပါသည်။"); } });
        closeAdminModalButton.addEventListener('click', closeAdminPanel);
        resetButton.addEventListener('click', resetAllSeats);
        copyAbsentButton.addEventListener('click', () => copyList('absent', copyAbsentButton));
        copyLeaveButton.addEventListener('click', () => copyList('on-leave', copyLeaveButton));

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStudentData();
            const todayDate = getBurmeseDate();
            currentDateAbsentEl.textContent = todayDate;
            currentDateLeaveEl.textContent = todayDate;
        });
    </script>
</body>
</html>
